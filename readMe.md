# Backend Lesson App - Prisma Версия

Данная ветка проекта **Backend Lesson App** заменяет Sequelize на Prisma в качестве инструмента для взаимодействия с базой данных. Ниже приведена подробная информация о настройке проекта, его структуре и ключевых пояснениях для начала работы с этой версией.

## Настройка проекта

Следуйте приведенным ниже шагам, чтобы настроить проект локально:

### Предварительные требования

- **Node.js** (версия 16 или выше)
- **PostgreSQL** (запущенный экземпляр, желательно локальный для разработки)
- **Git**

### Настройка окружения

1. Клонируйте репозиторий и переключитесь на эту ветку (`prisma-migration`):
   ```sh
   git clone https://github.com/IamRomanyuta/backend-lesson-app.git
   cd backend-lesson-app
   git checkout prisma
   ```

2. Установите все необходимые зависимости:
   ```sh
   npm install
   ```

3. Настройте переменные окружения.
   Создайте файл `.env` в корне проекта со следующим содержанием:
   ```env
   DATABASE_URL=postgres://postgres:admin@localhost:5432/lessons_db
   PORT=3000
   ```
   Обновите `DATABASE_URL` в соответствии с вашими локальными настройками PostgreSQL.

4. Подготовьте базу данных с помощью Prisma.
   - Выполните миграции, чтобы создать необходимые таблицы в базе данных PostgreSQL:
     ```sh
     npx prisma migrate dev --name init
     ```
   - Сгенерируйте клиент Prisma:
     ```sh
     npx prisma generate
     ```

### Запуск приложения

1. Скомпилируйте файлы TypeScript:
   ```sh
   npm run build
   ```

2. Запустите сервер:
   ```sh
   npm start
   ```

   После успешного запуска сервер будет доступен по адресу: `http://localhost:3000`.

## Структура проекта

- **prisma/schema.prisma**: Файл схемы Prisma, который определяет модели, их связи и конфигурацию базы данных.
- **src/controllers/lessonController.ts**: Содержит контроллер для обработки API-запросов, связанных с уроками, включая фильтрацию и пагинацию с использованием Prisma.
- **src/routes/lessonRoutes.ts**: Определяет маршруты для API, связанные с уроками.
- **src/config/prisma.ts**: Конфигурация для инициализации клиента Prisma.
- **src/interfaces/lessonInterfaces.ts**: Содержит интерфейсы TypeScript, используемые в проекте, обеспечивая безопасность типов.

## Детали API

Основной конечной точкой API для данного проекта является:

### `/api/v1/lessons`

**Метод**: `GET`

**Описание**: Возвращает список уроков из базы данных. Поддерживает фильтрацию и пагинацию на основе следующих параметров запроса:

- **`date`**: Определенная дата (`YYYY-MM-DD`) или диапазон дат, разделенных запятой (например, `2019-01-01,2019-09-01`).
- **`status`**: Статус урока (`0` - не проведен, `1` - проведен).
- **`teacherIds`**: ID учителей через запятую (например, `1,3`). Возвращает уроки, проводимые любым из указанных учителей.
- **`studentsCount`**: Количество учеников, записанных на урок. Принимает одно число или диапазон (например, `2,5`).
- **`page`**: Номер страницы для получения (по умолчанию `1`).
- **`lessonsPerPage`**: Количество уроков на странице (по умолчанию `5`).

### Пример использования

```sh
curl -X GET "http://localhost:3000/api/v1/lessons?date=2019-09-01,2019-09-04&status=1&teacherIds=1,3&studentsCount=2,5&page=1&lessonsPerPage=5"
```

## Тестирование API

Чтобы убедиться, что все работает корректно:

- Выполните предоставленные **curl** команды или используйте инструмент, такой как **Postman**, для отправки запросов на сервер.
- Убедитесь, что фильтрация, пагинация и другие параметры работают в соответствии с указанными спецификациями API.

## Ключевые пояснения

- **Миграции Prisma**: Prisma использует миграции для обеспечения соответствия схемы базы данных моделям. Используйте `npx prisma migrate dev`, чтобы применить изменения в процессе разработки.
- **Клиент Prisma**: После любых изменений в схеме используйте `npx prisma generate`, чтобы пересоздать клиент для использования в кодовой базе.

## Возможные проблемы

1. **Проблемы с подключением к базе данных**: Убедитесь, что PostgreSQL запущен и `DATABASE_URL` правильно настроен в вашем `.env` файле.
2. **Ошибки Prisma**: Запускайте `npx prisma generate` после внесения изменений в схему или после выполнения миграций.
3. **Ошибки компиляции TypeScript**: Убедитесь, что TypeScript правильно настроен (`tsconfig.json`), и выполните `npm run build`, чтобы проверить наличие ошибок.

## Полезные команды

- **Запуск в режиме разработки**: Для локальной разработки используйте `npm run dev` (требуется установка инструментов, таких как **nodemon**).
- **Сброс базы данных**: Чтобы сбросить базу данных и повторно выполнить миграции:
  ```sh
  npx prisma migrate reset
  ```

## Дополнительные ресурсы

- [Документация Prisma](https://www.prisma.io/docs/)
- [Документация Node.js](https://nodejs.org/en/docs/)
- [Документация PostgreSQL](https://www.postgresql.org/docs/)

